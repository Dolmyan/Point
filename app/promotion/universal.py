import logging
import asyncio
import os
import re
import time
from datetime import datetime, timedelta

from aiogram.enums import ParseMode, ChatMemberStatus
from aiogram.fsm import state
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, \
    KeyboardButton, user
from aiogram import Router, F, Bot
from aiogram.filters import CommandStart, Command
from app.generators import *
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types import ContentType

from app.handlers import menu
from app.states import Form
from config import *
from database import BotDB
from funcs import show_waiting_animation, response_generator, text_or_voice
import io
import openai
import subprocess


db = BotDB('point.db')
router = Router()
bot = Bot(token=TG_TOKEN)


logger = logging.getLogger(__name__)

PROMPTS = {
    "webinar_ideas": (
        "–ó–∞–¥–∞—á–∞: –ø—Ä–∏–¥—É–π 8‚Äì10 –ø—Ä–æ—Å—Ç—ã—Ö –∏ —Ä–∞–±–æ—á–∏—Ö –∏–¥–µ–π –¥–ª—è –≤–µ–±–∏–Ω–∞—Ä–æ–≤/–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –Ω–∏—à–µ.\n"
        "–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫. –î–ª—è –∫–∞–∂–¥–æ–π –∏–¥–µ–∏ —É–∫–∞–∂–∏ –ø–æ–¥—Ä—è–¥ (–∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É):\n"
        "üéØ –ù–∞–∑–≤–∞–Ω–∏–µ: (3‚Äì5 —Å–ª–æ–≤)\n"
        "ü™ù –•—É–∫: (–æ–¥–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–æ–Ω—Å–∞)\n"
        "üìå –§–æ—Ä–º–∞—Ç –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: (live/–≤–µ–±–∏–Ω–∞—Ä/–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, –º–∏–Ω—É—Ç—ã)\n"
        "‚ú® –ß—Ç–æ –¥–∞—Å—Ç —É—á–∞—Å—Ç–Ω–∏–∫—É: (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n"
        "üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ —Ç–∞–π–º–∏–Ω–≥—É: (–∫—Ä–∞—Ç–∫–æ, 3‚Äì5 –±–ª–æ–∫–æ–≤ —Å –º–∏–Ω—É—Ç–∞–º–∏)\n"
        "üëâ CTA: (—á—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤ –∫–æ–Ω—Ü–µ: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–∑–∞—è–≤–∫–∞/–ø–æ–∫—É–ø–∫–∞)\n"
        "üë• –¶–ê: (–¥–ª—è –∫–æ–≥–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ: –Ω–æ–≤–∏—á–æ–∫/–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∏ —Ç.–¥.)\n"
        "üí° –°–æ–≤–µ—Ç –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏: (1 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏—ë–º)\n\n"
        "–ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ –∏ —è—Å–Ω–æ. –ù–µ –¥–æ–±–∞–≤–ª—è–π –≤–≤–æ–¥–Ω—ã—Ö/–∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π."
    ),

    "live_plan": (
        "–ó–∞–¥–∞—á–∞: —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π –ø–ª–∞–Ω –ø—Ä—è–º–æ–≥–æ —ç—Ñ–∏—Ä–∞ –Ω–∞ 30‚Äì45 –º–∏–Ω—É—Ç.\n"
        "–í—ã–¥–∞–π —á–µ—Ç–∫–æ –∏ –ø–æ —à–∞–≥–∞–º:\n"
        "üéØ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç—Ñ–∏—Ä–∞\n"
        "üéØ –¶–µ–ª—å —ç—Ñ–∏—Ä–∞ (–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\n"
        "üë• –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è\n"
        "‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)\n"
        "üìã –¢–∞–π–º–ª–∞–π–Ω (–ø–æ –±–ª–æ–∫–∞–º):\n"
        "- 00:00‚Äì03:00 ‚Äî –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ (hook + –æ–±–µ—â–∞–Ω–∏–µ –ø–æ–ª—å–∑—ã)\n"
        "- 03:00‚Äì12:00 ‚Äî –ë–ª–æ–∫ 1 (–∫–ª—é—á–µ–≤–∞—è –ø–æ–ª—å–∑–∞)\n"
        "- 12:00‚Äì22:00 ‚Äî –ë–ª–æ–∫ 2 (–ø—Ä–∏–º–µ—Ä/–∫–µ–π—Å)\n"
        "- 22:00‚Äì30:00 ‚Äî –ü—Ä–∞–∫—Ç–∏–∫–∞/–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è\n"
        "- 30:00‚Äì40:00 ‚Äî Q&A\n"
        "- 40:00‚Äì45:00 ‚Äî –ó–∞–∫—Ä—ã—Ç–∏–µ + CTA\n\n"
        "–î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –¥–∞–π 2‚Äì3 –ø–æ–¥—Å–∫–∞–∑–∫–∏, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å/–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ 3 –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ö—É–∫–∞ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è. –í –∫–æ–Ω—Ü–µ ‚Äî 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ CTA –∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —á–µ–∫–ª–∏—Å—Ç (–∑–≤—É–∫, —Å–≤–µ—Ç, —Å–ª–∞–π–¥—ã).\n\n"
        "–ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π."
    ),

    "webinar_script": (
        "–ó–∞–¥–∞—á–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–¥–∞—é—â–µ–≥–æ –≤–µ–±–∏–Ω–∞—Ä–∞ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ (–º–∞–∫—Å. 10 –ø—É–Ω–∫—Ç–æ–≤).\n"
        "–§–æ—Ä–º–∞—Ç: –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —É–∫–∞–∂–∏ –∫—Ä–∞—Ç–∫–æ:\n"
        "1) –¶–µ–ª—å –±–ª–æ–∫–∞\n"
        "2) –ß—Ç–æ —Å–∫–∞–∑–∞—Ç—å (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n"
        "3) –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä (–¥–æ–≤–µ—Ä–∏–µ/—É–¥–∏–≤–ª–µ–Ω–∏–µ/—Å—Ä–æ—á–Ω–æ—Å—Ç—å –∏ —Ç.–ø.)\n"
        "4) –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É\n\n"
        "–í –∫–æ–Ω—Ü–µ –¥–∞–π 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ CTA (–º—è–≥–∫–∏–π –∏ –ø—Ä—è–º–æ–π) –∏ 3 –ø—Ä–∏—ë–º–∞, –∫–∞–∫ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –≤ –ø–µ—Ä–≤—ã–µ 30 —Å–µ–∫—É–Ω–¥.\n\n"
        "–ü–∏—à–∏ —á—ë—Ç–∫–æ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π."
    ),

    "lesson_plan": (
        "–ó–∞–¥–∞—á–∞: —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π –ø–ª–∞–Ω —É—Ä–æ–∫–∞ –Ω–∞ 60 –º–∏–Ω—É—Ç.\n"
        "–§–æ—Ä–º–∞—Ç (–ø–æ—Ä—è–¥–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):\n"
        "üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞\n"
        "üéØ –¶–µ–ª—å —É—Ä–æ–∫–∞ (—á—Ç–æ —É—á–µ–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –ø–æ—Å–ª–µ –∑–∞–Ω—è—Ç–∏—è)\n"
        "üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (—Å–ø–∏—Å–æ–∫)\n"
        "‚è±Ô∏è –¢–∞–π–º–ª–∞–π–Ω:\n"
        "- 00:00‚Äì05:00 ‚Äî –†–∞–∑–æ–≥—Ä–µ–≤ (–≤–æ–ø—Ä–æ—Å/–º–∏–Ω–∏-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)\n"
        "- 05:00‚Äì20:00 ‚Äî –¢–µ–æ—Ä–∏—è (3‚Äì5 –≥–ª–∞–≤–Ω—ã—Ö —Ç–µ–∑–∏—Å–æ–≤)\n"
        "- 20:00‚Äì40:00 ‚Äî –ü—Ä–∞–∫—Ç–∏–∫–∞ (–∑–∞–¥–∞–Ω–∏–µ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)\n"
        "- 40:00‚Äì50:00 ‚Äî –†–∞–∑–±–æ—Ä/—Ñ–∏–¥–±–µ–∫\n"
        "- 50:00‚Äì60:00 ‚Äî –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –∏—Ç–æ–≥\n\n"
        "–î–æ–±–∞–≤—å 3 –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞/–∑–∞–¥–∞–Ω–∏—è –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É–ø—Ä–æ—â–µ–Ω–∏—è/—É—Å–ª–æ–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π. –ü–∏—à–∏ —è—Å–Ω–æ –∏ –ø–æ –¥–µ–ª—É."
    ),

    "podcast_questions": (
        "–ó–∞–¥–∞—á–∞: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 12 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–¥–∫–∞—Å—Ç–∞/–∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ —Ç–µ–º–µ.\n"
        "–†–∞–∑–±–µ–π –Ω–∞ 3 –±–ª–æ–∫–∞ –ø–æ 4 –≤–æ–ø—Ä–æ—Å–∞: –≤–≤–æ–¥–Ω—ã–µ, –≥–ª—É–±–∏–Ω–Ω—ã–µ, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ/–∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ.\n"
        "–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ + –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫.\n"
        "–î–ª—è 3‚Äì4 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤—å –∫–æ—Ä–æ—Ç–∫–∏–π follow-up (–ø–æ–¥—Å–∫–∞–∑–∫—É, –∫–∞–∫ —É–≥–ª—É–±–∏—Ç—å –æ—Ç–≤–µ—Ç).\n"
        "–í –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —ç–ø–∏–∑–æ–¥–∞ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–µ–≥–º–µ–Ω—Ç—ã) –∏ –∏–¥–µ—é, –∫–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –∏–ª–∏ —Å—Ç–æ—Ä–∏—Å.\n\n"
        "–ü–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ."
    ),

    "newsletter_ideas": (
        "–ó–∞–¥–∞—á–∞: –ø—Ä–∏–¥—É–º–∞—Ç—å 10 —Ç–µ–º –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫/—Å–µ—Ä–∏–π –ø–∏—Å–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≥—Ä–µ–≤–∞—é—Ç –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç.\n"
        "–î–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫:\n"
        "üìå –¢–µ–º–∞\n"
        "‚úâÔ∏è –í–∞—Ä–∏–∞–Ω—Ç—ã subject line (2 —à—Ç.)\n"
        "üîé –ü—Ä–µ–≤—å—é (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n"
        "üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (3‚Äì4 –ø—É–Ω–∫—Ç–∞ ‚Äî —á—Ç–æ –≤ –ø–∏—Å—å–º–µ)\n"
        "üëâ CTA (—á—Ç–æ –ø—Ä–æ—Å–∏–º —Å–¥–µ–ª–∞—Ç—å)\n"
        "üïí –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–µ–Ω—å 1/—á–µ—Ä–µ–∑ 3 –¥–Ω—è)\n\n"
        "–í—ã–≤–æ–¥ ‚Äî –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ 10 —Ç–∞–∫–∏—Ö –±–ª–æ–∫–æ–≤. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ, –ø–æ–ª–µ–∑–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤."
    ),
    "trand_analysis": (
        "–ó–∞–¥–∞—á–∞: –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–µ–∂–∏–µ —Ç—Ä–µ–Ω–¥—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –Ω–∏—à–µ –∏ –≤—ã–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±–∑–æ—Ä.\n"
        "–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:\n"
        "üìä –¢—Ä–µ–Ω–¥ (–∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)\n"
        "üîé –°—É—Ç—å: (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤ —á—ë–º —Ç—Ä–µ–Ω–¥)\n"
        "üìà –ü–æ—á–µ–º—É –∞–∫—Ç—É–∞–ª—å–Ω–æ: (—Ñ–∞–∫—Ç/–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ/–¥–∞–Ω–Ω—ã–µ)\n"
        "‚ú® –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –Ω–∏—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: (1‚Äì2 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏—ë–º–∞)\n"
        "üöÄ –ò–¥–µ—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞: (–ø—Ä–∏–º–µ—Ä –¥–ª—è –ø–æ—Å—Ç–∞/—Ä–∏–ª—Å–∞/–≤–µ–±–∏–Ω–∞—Ä–∞)\n"
        "üí° –°–æ–≤–µ—Ç: (–º–∞–ª–µ–Ω—å–∫–∏–π –∏–Ω—Å–∞–π—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)\n\n"
        "–í—ã–≤–µ–¥–∏ 5‚Äì7 —Ç—Ä–µ–Ω–¥–æ–≤. –ü–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã –∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π."
    ),
    "stories_warmup": (
        "–ó–∞–¥–∞—á–∞: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ—ë–º –ø—Ä–æ–¥—É–∫—Ç–µ –≤ 6 —Å—Ç–æ—Ä–∏—Å —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤–∏–∑—É–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥), —Ç–µ–∫—Å—Ç–æ–º –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ (Poll, Quiz, Question), –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.\n\n"
        "–§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ—Ä–∏—Å–∞:\n\n"
        "Stories N\n\n"
        "üñºÔ∏è/üé• –û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∞\n\n"
        "üí¨ –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞ —Å—Ç–æ—Ä–∏—Å\n\n"
        "–ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤: Poll / Quiz / Question —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏\n\n"
        "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º, –≤–æ–≤–ª–µ–∫–∞—é—â–∏–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –∏ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤. "
        "–ö–∞–∂–¥—ã–π —Å—Ç–æ—Ä–∏—Å –¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—á–Ω–æ –≤–µ—Å—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É, —Å–æ–∑–¥–∞–≤–∞—è –∏—Å—Ç–æ—Ä–∏—é —É—Å–ø–µ—Ö–∞ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é –∫ –æ–±—É—á–µ–Ω–∏—é.\n"
        "–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É —Å—Ç–æ—Ä–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, '---')."
    ),
    "weekly_warmup": (
        "–ó–∞–¥–∞—á–∞: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ—ë–º –ø—Ä–æ–¥—É–∫—Ç–µ –≤ 7 —Å—Ç–æ—Ä–∏—Å, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏. "
        "–ö–∞–∂–¥—ã–π —Å—Ç–æ—Ä–∏—Å –¥–æ–ª–∂–µ–Ω –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–æ–≤–ª–µ–∫–∞—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –ø–æ–¥–≤–æ–¥–∏—Ç—å –∫ —Ü–µ–ª–µ–≤–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –∑–∞—è–≤–∫–∞, –ø–æ–¥–ø–∏—Å–∫–∞). "
        "–í–∫–ª—é—á–∞–π—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ª–∞–π–¥), —Ç–µ–∫—Å—Ç –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (Poll, Quiz, Question), –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.\n\n"
        "–§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ—Ä–∏—Å–∞:\n\n"
        "Stories N\n\n"
        "üñºÔ∏è/üé• –û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∞\n\n"
        "üí¨ –¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞ —Å—Ç–æ—Ä–∏—Å\n\n"
        "–ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤: Poll / Quiz / Question —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏\n\n"
        "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º, –≤–æ–≤–ª–µ–∫–∞—é—â–∏–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –∏ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤. "
        "–ö–∞–∂–¥—ã–π —Å—Ç–æ—Ä–∏—Å –¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—á–Ω–æ –≤–µ—Å—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É, —Å–æ–∑–¥–∞–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –¥–æ–≤–µ—Ä–∏–µ –∫ –ø—Ä–æ–¥—É–∫—Ç—É.\n"
        "–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É —Å—Ç–æ—Ä–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, '---')."
    ),

}


@router.callback_query(lambda c: c.data in [
    "webinar_ideas",
    "live_plan",
    "webinar_script",
    "lesson_plan",
    "podcast_questions",
    "newsletter_ideas",
    "trand_analysis",
    "stories_warmup",
    "weekly_warmup"
])
async def universal(callback_query: CallbackQuery, state: FSMContext):
    await state.update_data(selected_callback=callback_query.data)
    user_id=callback_query.from_user.id

    from app.subscription_funcs import SubscriptionManager
    subscription_manager = SubscriptionManager(db, bot)
    if not await subscription_manager.can_generate(user_id):
        return  # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ –∏–¥—ë—Ç
    await callback_query.message.answer(
            "üñãÔ∏è <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞</b>\n\n"
            "üí° –î–∞–≤–∞–π –æ–ø—Ä–µ–¥–µ–ª–∏–º—Å—è —Å —Ç–µ–º–æ–π! "
            "–ß–µ–º —Ç–æ—á–Ω–µ–µ –æ–ø–∏—à–µ—à—å, —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –∏ –ø–æ–ª–µ–∑–Ω–µ–µ –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n\n"
            "üëá –ù–∞–ø–∏—à–∏, –Ω–∞ –∫–∞–∫—É—é —Ç–µ–º—É –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å "
            "–∏–ª–∏ –∑–∞–ø–∏—à–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ üéôÔ∏è:",
            parse_mode="HTML"
    )

    await state.set_state(Form.theme_universal)

@router.message(Form.theme_universal)
async def universal_handler(message: Message, state: FSMContext):
    theme_text = await text_or_voice(message)
    user_id = message.from_user.id


    goal = f"{db.get_business(user_id=user_id)} –¢–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {theme_text}"
    data = await state.get_data()
    selected = data.get("selected_callback")
    prompt_template = PROMPTS[selected]


    content=f'''
                    –ú–æ—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {goal}
                    {prompt_template}
                    '''

    request_task = asyncio.create_task(
            generator(user_id=message.from_user.id, content=content)
    )
    response = await response_generator(message, request_task, bot=bot)
    await state.set_state(Form.clear)
